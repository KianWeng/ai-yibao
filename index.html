<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧医康保险服务平台</title>
  <!-- 引入依赖 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/element-plus@2.3.9/dist/index.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/element-plus@2.3.9/dist/index.full.min.js"></script>
  
  <!-- 自定义样式 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-item-active {
        @apply bg-blue-50 text-blue-600 border-l-4 border-blue-500;
      }
      .card-shadow {
        @apply shadow-md hover:shadow-lg transition-shadow duration-300;
      }
    }
    
    /* AI助手动画 */
    .slide-left-enter-active,
    .slide-left-leave-active {
      transition: transform 0.3s ease;
    }
    .slide-left-enter-from {
      transform: translateX(100%);
    }
    .slide-left-leave-to {
      transform: translateX(100%);
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            gray: {
              100: '#F5F7FA',
              200: '#E4E7ED',
              300: '#C0C4CC',
              400: '#909399',
              500: '#606266',
              600: '#303133',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
</head>
<body class="bg-gray-100 font-sans text-gray-600 min-h-screen flex flex-col">
  <div id="app" class="flex flex-col h-screen overflow-hidden">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-10">
      <div class="flex items-center">
        <div class="text-primary text-2xl font-bold flex items-center">
          <i class="fa fa-heartbeat mr-2"></i>
          <span>智慧医康保险服务平台</span>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <el-badge :count="3" class="mr-4">
          <el-icon class="cursor-pointer text-gray-500 hover:text-primary text-xl">
            <i class="fa fa-bell-o"></i>
          </el-icon>
        </el-badge>
        <el-dropdown @command="handleUserCommand" trigger="click">
          <div class="flex items-center cursor-pointer">
            <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full mr-2">
            <span class="text-gray-600">{{ userInfo.realName || userInfo.username || '管理员' }}</span>
            <el-icon class="ml-1 text-gray-400">
              <i class="fa fa-angle-down"></i>
            </el-icon>
          </div>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item command="profile">
                <i class="fa fa-user mr-2"></i>个人中心
              </el-dropdown-item>
              <el-dropdown-item command="logout" divided>
                <i class="fa fa-sign-out mr-2"></i>退出登录
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- 侧边栏 -->
      <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 overflow-y-auto">
        <div class="p-4">
          <div class="text-sm font-medium text-gray-400 mb-2">核心功能</div>
          <el-menu :default-active="activeMenu" @select="activeMenu = $event" class="border-none">
            <el-menu-item index="dashboard" class="mb-1">
              <template #icon>
                <i class="fa fa-tachometer text-gray-500"></i>
              </template>
              <span>数据概览</span>
            </el-menu-item>
            <el-menu-item index="drg" class="mb-1">
              <template #icon>
                <i class="fa fa-file-text-o text-gray-500"></i>
              </template>
              <span>DRG支付政策</span>
            </el-menu-item>
            <el-menu-item index="rehabilitation" class="mb-1">
              <template #icon>
                <i class="fa fa-hospital-o text-gray-500"></i>
              </template>
              <span>康复服务衔接</span>
            </el-menu-item>
            <el-menu-item index="risk-control" class="mb-1">
              <template #icon>
                <i class="fa fa-shield text-gray-500"></i>
              </template>
              <span>风控与预测</span>
            </el-menu-item>
            <el-menu-item index="data-management" class="mb-1">
              <template #icon>
                <i class="fa fa-database text-gray-500"></i>
              </template>
              <span>数据管理</span>
            </el-menu-item>
          </el-menu>
        </div>
        
        <div class="p-4 border-t border-gray-200">
          <div class="text-sm font-medium text-gray-400 mb-2">系统设置</div>
          <el-menu :default-active="activeMenu" @select="activeMenu = $event" class="border-none">
            <el-menu-item index="system" class="mb-1">
              <template #icon>
                <i class="fa fa-cog text-gray-500"></i>
              </template>
              <span>系统配置</span>
            </el-menu-item>
            <el-menu-item index="user" class="mb-1">
              <template #icon>
                <i class="fa fa-user-o text-gray-500"></i>
              </template>
              <span>用户管理</span>
            </el-menu-item>
            <el-menu-item index="log" class="mb-1">
              <template #icon>
                <i class="fa fa-history text-gray-500"></i>
              </template>
              <span>操作日志</span>
            </el-menu-item>
            <el-menu-item index="help" class="mb-1">
              <template #icon>
                <i class="fa fa-question-circle text-gray-500"></i>
              </template>
              <span>使用说明</span>
            </el-menu-item>
          </el-menu>
        </div>
      </aside>

      <!-- 主内容区 -->
      <main class="flex-1 overflow-y-auto p-6 bg-gray-100">
        <!-- 数据概览页面 -->
        <div v-if="activeMenu === 'dashboard'" class="space-y-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-600">数据概览</h1>
            <el-date-picker
              v-model="dateRange"
              type="daterange"
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              class="w-64"
            />
          </div>

          <!-- 核心指标卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm mb-1">支付效率提升</p>
                  <h3 class="text-2xl font-bold text-gray-600">{{ dashboardData.paymentEfficiency.value }}%</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-primary">
                  <i class="fa fa-money text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-success flex items-center">
                  <i class="fa fa-arrow-up mr-1"></i> 较上月提升{{ dashboardData.paymentEfficiency.change }}%
                </span>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm mb-1">康复衔接效率</p>
                  <h3 class="text-2xl font-bold text-gray-600">{{ dashboardData.rehabilitationEfficiency.value }}%</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-success">
                  <i class="fa fa-exchange text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-success flex items-center">
                  <i class="fa fa-arrow-up mr-1"></i> 转院耗时缩短至3.5天
                </span>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm mb-1">赔付率下降</p>
                  <h3 class="text-2xl font-bold text-gray-600">{{ dashboardData.payoutRate.value }}%</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                  <i class="fa fa-line-chart text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-success flex items-center">
                  <i class="fa fa-arrow-down mr-1"></i> 较行业平均低{{ Math.abs(dashboardData.payoutRate.change) }}%
                </span>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-400 text-sm mb-1">门诊结算时间</p>
                  <h3 class="text-2xl font-bold text-gray-600">{{ dashboardData.settlementTime.value }}秒</h3>
                </div>
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                  <i class="fa fa-clock-o text-xl"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center text-sm">
                <span class="text-success flex items-center">
                  <i class="fa fa-arrow-down mr-1"></i> 替代传统10-15分钟
                </span>
              </div>
            </div>
          </div>

          <!-- 图表区域 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-600">医保费用趋势</h3>
                <el-select v-model="feeType" size="small" class="w-32">
                  <el-option label="月度" value="month"></el-option>
                  <el-option label="季度" value="quarter"></el-option>
                  <el-option label="年度" value="year"></el-option>
                </el-select>
              </div>
              <div id="feeTrendChart" class="w-full h-64"></div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-600">风控预警分布</h3>
                <el-button type="text" size="small" class="text-primary">
                  查看详情 <i class="fa fa-angle-right ml-1"></i>
                </el-button>
              </div>
              <div id="riskDistributionChart" class="w-full h-64"></div>
            </div>
          </div>

          <!-- 最近预警列表 -->
          <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-600">最近风控预警</h3>
              <el-button type="primary" size="small" @click="refreshWarnings">
                <i class="fa fa-refresh mr-1"></i> 刷新
              </el-button>
            </div>
            <el-table :data="warningList" border stripe :header-cell-style="{background: '#f5f7fa'}">
              <el-table-column prop="id" label="预警ID" width="100"></el-table-column>
              <el-table-column prop="hospital" label="医院名称"></el-table-column>
              <el-table-column prop="type" label="预警类型" width="120">
                <template #default="scope">
                  <el-tag :type="scope.row.type === '欺诈风险' ? 'danger' : 'warning'">
                    {{ scope.row.type }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="amount" label="涉及金额" width="120"></el-table-column>
              <el-table-column prop="time" label="预警时间" width="180"></el-table-column>
              <el-table-column prop="status" label="处理状态" width="120">
                <template #default="scope">
                  <el-tag :type="scope.row.status === '已处理' ? 'success' : 'info'">
                    {{ scope.row.status }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="120">
                <template #default>
                  <el-button type="text" size="small" class="text-primary">查看</el-button>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- DRG支付政策页面 -->
        <div v-if="activeMenu === 'drg'" class="space-y-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-600">DRG支付政策管理</h1>
            <el-button type="primary" @click="showDrgDialog">
              <i class="fa fa-plus mr-1"></i> 新增政策
            </el-button>
          </div>
          
          <!-- DRG政策编辑对话框 -->
          <el-dialog
            :title="drgDialogTitle"
            v-model="drgDialogVisible"
            width="600px"
            @close="resetDrgForm"
          >
            <el-form
              ref="drgFormRef"
              :model="drgForm"
              :rules="drgRules"
              label-width="120px"
            >
              <el-form-item label="DRG组编码" prop="drgCode">
                <el-input v-model="drgForm.drgCode" placeholder="请输入DRG组编码" :disabled="drgForm.id"></el-input>
              </el-form-item>
              
              <el-form-item label="DRG组名称" prop="drgName">
                <el-input v-model="drgForm.drgName" placeholder="请输入DRG组名称" />
              </el-form-item>
              
              <el-form-item label="适用诊断">
                <el-input
                  v-model="drgForm.diagnosis"
                  type="textarea"
                  :rows="3"
                  placeholder="请输入适用诊断"
                />
              </el-form-item>
              
              <el-form-item label="支付标准" prop="paymentStandard">
                <el-input-number
                  v-model="drgForm.paymentStandard"
                  :min="0"
                  :precision="2"
                  placeholder="请输入支付标准"
                  style="width: 100%"
                />
              </el-form-item>
              
              <el-form-item label="生效日期" prop="effectiveDate">
                <el-date-picker
                  v-model="drgForm.effectiveDate"
                  type="date"
                  placeholder="选择生效日期"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                  style="width: 100%"
                />
              </el-form-item>
              
              <el-form-item label="状态">
                <el-switch
                  v-model="drgForm.status"
                  active-value="1"
                  inactive-value="0"
                  active-text="启用"
                  inactive-text="禁用"
                />
              </el-form-item>
            </el-form>
            
            <template #footer>
              <span class="dialog-footer">
                <el-button @click="drgDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitDrgForm" :loading="drgSubmitting">确定</el-button>
              </span>
            </template>
          </el-dialog>

          <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex flex-wrap gap-4 mb-6">
              <el-input v-model="drgSearch" placeholder="搜索DRG组/诊断名称" class="w-64"></el-input>
              <el-select v-model="drgStatus" placeholder="选择状态" class="w-32">
                <el-option label="全部" value=""></el-option>
                <el-option label="启用" value="1"></el-option>
                <el-option label="禁用" value="0"></el-option>
              </el-select>
              <el-button type="primary" @click="handleDrgSearch">搜索</el-button>
              <el-button type="default" @click="handleDrgReset">重置</el-button>
            </div>

            <el-table :data="drgList" border stripe :header-cell-style="{background: '#f5f7fa'}">
              <el-table-column prop="drgCode" label="DRG组编码" width="120"></el-table-column>
              <el-table-column prop="drgName" label="DRG组名称"></el-table-column>
              <el-table-column prop="diagnosis" label="适用诊断"></el-table-column>
              <el-table-column prop="paymentStandard" label="支付标准" width="120"></el-table-column>
              <el-table-column prop="effectiveDate" label="生效日期" width="150"></el-table-column>
              <el-table-column prop="status" label="状态" width="100">
                <template #default="scope">
                  <el-switch v-model="scope.row.status" active-value="1" inactive-value="0" disabled></el-switch>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="180">
                <template #default="scope">
                  <el-button type="text" size="small" class="text-primary" @click="handleDrgEdit(scope.row)">编辑</el-button>
                  <el-button type="text" size="small" class="text-danger" @click="handleDrgDelete(scope.row)">删除</el-button>
                </template>
              </el-table-column>
            </el-table>

            <div class="mt-4 flex justify-center">
              <el-pagination
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange"
                :current-page="drgCurrentPage"
                :page-sizes="[10, 20, 50, 100]"
                :page-size="drgPageSize"
                layout="total, sizes, prev, pager, next, jumper"
                :total="drgTotal"
              ></el-pagination>
            </div>
          </div>

          <!-- DRG分组统计 -->
          <div class="bg-white rounded-lg p-6 card-shadow">
            <h3 class="font-semibold text-gray-600 mb-4">DRG分组统计</h3>
            <div id="drgGroupChart" class="w-full h-64"></div>
          </div>
        </div>

        <!-- 康复服务衔接页面 -->
        <div v-if="activeMenu === 'rehabilitation'" class="space-y-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-600">康复服务衔接管理</h1>
            <el-button type="primary" @click="showRehabDialog">
              <i class="fa fa-plus mr-1"></i> 新增康复机构
            </el-button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg p-6 card-shadow lg:col-span-1">
              <h3 class="font-semibold text-gray-600 mb-4">转院申请统计</h3>
              
              <!-- 统计数字部分 - 移到图表上方 -->
              <div class="mb-4 space-y-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">今日申请数</p>
                  <h4 class="text-xl font-bold text-gray-600">{{ transferStats?.today || 0 }}</h4>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">本周申请数</p>
                  <h4 class="text-xl font-bold text-gray-600">{{ transferStats?.week || 0 }}</h4>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">本月申请数</p>
                  <h4 class="text-xl font-bold text-gray-600">{{ transferStats?.month || 0 }}</h4>
                </div>
              </div>
              
              <!-- 状态分布饼图 -->
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">申请状态分布</h4>
                <div id="transferApplyChart" class="w-full h-40"></div>
              </div>
              
              <!-- 转院申请趋势图表 -->
              <div>
                <h4 class="text-sm font-semibold text-gray-600 mb-2">申请趋势</h4>
                <div id="transferTrendChart" class="w-full h-40"></div>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow lg:col-span-2">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-600">康复机构列表</h3>
                <el-input v-model="rehabSearch" placeholder="搜索机构名称" class="w-48"></el-input>
              </div>
              <el-table :data="rehabList" border stripe :header-cell-style="{background: '#f5f7fa'}">
                <el-table-column prop="name" label="机构名称"></el-table-column>
                <el-table-column prop="level" label="机构等级" width="120"></el-table-column>
                <el-table-column prop="bedCount" label="床位数" width="100"></el-table-column>
                <el-table-column prop="specialty" label="擅长领域"></el-table-column>
                <el-table-column prop="status" label="状态" width="100">
                  <template #default="scope">
                    <el-tag :type="scope.row.status === '营业中' ? 'success' : 'danger'">
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="操作" width="180">
                  <template #default="scope">
                    <el-button type="text" size="small" class="text-primary" @click="showRehabDetail(scope.row)">详情</el-button>
                    <el-button type="text" size="small" class="text-success" @click="handleRehabEdit(scope.row)">修改</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- 转院申请处理 -->
          <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-600">待处理转院申请</h3>
              <el-select v-model="transferStatus" placeholder="选择状态" class="w-32">
                <el-option label="全部" value=""></el-option>
                <el-option label="待审核" value="pending"></el-option>
                <el-option label="已通过" value="approved"></el-option>
                <el-option label="已拒绝" value="rejected"></el-option>
              </el-select>
            </div>
            <el-table :data="transferList" border stripe :header-cell-style="{background: '#f5f7fa'}" v-loading="loading">
              <el-table-column prop="applyNo" label="申请单号" width="150"></el-table-column>
              <el-table-column prop="patientName" label="患者姓名" width="100"></el-table-column>
              <el-table-column prop="fromHospital" label="转出医院" width="150"></el-table-column>
              <el-table-column prop="toHospital" label="转入机构" width="150"></el-table-column>
              <el-table-column prop="disease" label="疾病诊断" width="120"></el-table-column>
              <el-table-column label="状态" width="100">
                <template #default="scope">
                  <el-tag v-if="scope.row.status === 'pending'" type="warning" size="small">待审核</el-tag>
                  <el-tag v-else-if="scope.row.status === 'approved'" type="success" size="small">已批准</el-tag>
                  <el-tag v-else-if="scope.row.status === 'rejected'" type="danger" size="small">已拒绝</el-tag>
                  <el-tag v-else type="info" size="small">{{ scope.row.status }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="applyTime" label="申请时间" width="180">
                <template #default="scope">
                  {{ formatDateTime(scope.row.applyTime) }}
                </template>
              </el-table-column>
              <el-table-column label="操作" width="220" fixed="right">
                <template #default="scope">
                  <el-button type="text" size="small" @click="viewTransferDetail(scope.row)">详情</el-button>
                  <el-button 
                    v-if="scope.row.status === 'pending'"
                    type="text" 
                    size="small" 
                    class="text-success" 
                    @click="handleTransferApprove(scope.row)"
                  >通过</el-button>
                  <el-button 
                    v-if="scope.row.status === 'pending'"
                    type="text" 
                    size="small" 
                    class="text-danger" 
                    @click="handleTransferReject(scope.row)"
                  >拒绝</el-button>
                  <span v-if="scope.row.status !== 'pending'" class="text-gray-400 text-sm">已处理</span>
                </template>
              </el-table-column>
            </el-table>
          </div>

          <!-- 新增康复机构对话框 -->
          <el-dialog
            v-model="rehabDialogVisible"
            :title="rehabDialogTitle"
            width="600px"
            @close="resetRehabForm"
          >
            <el-form
              ref="rehabFormRef"
              :model="rehabForm"
              :rules="rehabRules"
              label-width="120px"
            >
              <el-form-item label="机构名称" prop="name">
                <el-input v-model="rehabForm.name" placeholder="请输入机构名称" />
              </el-form-item>
              <el-form-item label="机构等级" prop="level">
                <el-select v-model="rehabForm.level" placeholder="请选择机构等级" style="width: 100%">
                  <el-option label="一级" value="一级" />
                  <el-option label="二级" value="二级" />
                  <el-option label="三级" value="三级" />
                  <el-option label="专科" value="专科" />
                </el-select>
              </el-form-item>
              <el-form-item label="床位数" prop="bedCount">
                <el-input-number v-model="rehabForm.bedCount" :min="0" style="width: 100%" />
              </el-form-item>
              <el-form-item label="擅长领域">
                <el-input v-model="rehabForm.specialty" placeholder="请输入擅长领域" />
              </el-form-item>
              <el-form-item label="价格水平">
                <el-select v-model="rehabForm.priceLevel" placeholder="请选择价格水平" style="width: 100%">
                  <el-option label="低" value="低" />
                  <el-option label="中等" value="中等" />
                  <el-option label="高" value="高" />
                </el-select>
              </el-form-item>
              <el-form-item label="地址">
                <el-input v-model="rehabForm.address" placeholder="请输入机构地址" />
              </el-form-item>
              <el-form-item label="联系电话">
                <el-input v-model="rehabForm.phone" placeholder="请输入联系电话" />
              </el-form-item>
              <el-form-item label="状态">
                <el-select v-model="rehabForm.status" placeholder="请选择状态" style="width: 100%">
                  <el-option label="营业中" value="营业中" />
                  <el-option label="暂停营业" value="暂停营业" />
                </el-select>
              </el-form-item>
              <el-form-item label="机构简介">
                <el-input
                  v-model="rehabForm.description"
                  type="textarea"
                  :rows="4"
                  placeholder="请输入机构简介"
                />
              </el-form-item>
            </el-form>
            <template #footer>
              <span class="dialog-footer">
                <el-button @click="rehabDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="submitRehabForm" :loading="rehabSubmitting">确定</el-button>
              </span>
            </template>
          </el-dialog>

          <!-- 康复机构详情对话框 -->
          <el-dialog
            v-model="rehabDetailDialogVisible"
            title="康复机构详情"
            width="700px"
          >
            <div v-if="rehabDetail" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-400 mb-1">机构名称</p>
                  <p class="text-base font-semibold text-gray-700">{{ rehabDetail.name }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">机构等级</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.level || '-' }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">床位数</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.bedCount || 0 }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">价格水平</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.priceLevel || '-' }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">状态</p>
                  <el-tag :type="rehabDetail.status === '营业中' ? 'success' : 'danger'">
                    {{ rehabDetail.status || '-' }}
                  </el-tag>
                </div>
                <div>
                  <p class="text-sm text-gray-400 mb-1">评分</p>
                  <p class="text-base text-gray-700">
                    <i class="fa fa-star text-yellow-400"></i>
                    {{ rehabDetail.rating || 0 }} 分
                  </p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-400 mb-1">擅长领域</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.specialty || '-' }}</p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-400 mb-1">地址</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.address || '-' }}</p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-400 mb-1">联系电话</p>
                  <p class="text-base text-gray-700">{{ rehabDetail.phone || '-' }}</p>
                </div>
                <div class="col-span-2">
                  <p class="text-sm text-gray-400 mb-1">机构简介</p>
                  <p class="text-base text-gray-700 whitespace-pre-wrap">{{ rehabDetail.description || '-' }}</p>
                </div>
              </div>
            </div>
            <template #footer>
              <span class="dialog-footer">
                <el-button type="primary" @click="rehabDetailDialogVisible = false">关闭</el-button>
              </span>
            </template>
          </el-dialog>
        </div>

        <!-- 风控与预测页面 -->
        <div v-if="activeMenu === 'risk-control'" class="space-y-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-600">风控与预测管理</h1>
            <el-button type="primary">
              <i class="fa fa-cog mr-1"></i> 模型配置
            </el-button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg p-6 card-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-600">风控概览</h3>
                <span class="text-sm text-gray-400">模型版本：v2.3.1</span>
              </div>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">召回率</span>
                  <span class="text-xl font-bold text-primary">{{ riskOverview.recall }}%</span>
                </div>
                <el-progress :percentage="riskOverview.recall" :stroke-width="6" color="#165DFF"></el-progress>
                
                <div class="flex justify-between items-center mt-6">
                  <span class="text-gray-600">误报率</span>
                  <span class="text-xl font-bold text-warning">{{ riskOverview.falsePositive }}%</span>
                </div>
                <el-progress :percentage="riskOverview.falsePositive" :stroke-width="6" color="#FAAD14"></el-progress>
                
                <div class="flex justify-between items-center mt-6">
                  <span class="text-gray-600">拦截成功率</span>
                  <span class="text-xl font-bold text-success">{{ riskOverview.success }}%</span>
                </div>
                <el-progress :percentage="riskOverview.success" :stroke-width="6" color="#52C41A"></el-progress>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <h3 class="font-semibold text-gray-600 mb-4">风险类型分布</h3>
              <div id="riskTypeChart" class="w-full h-64"></div>
            </div>

            <div class="bg-white rounded-lg p-6 card-shadow">
              <h3 class="font-semibold text-gray-600 mb-4">风险等级分布</h3>
              <div id="riskLevelChart" class="w-full h-64"></div>
            </div>
          </div>

          <!-- 风险事件列表 -->
          <div class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-600">风险事件记录</h3>
              <div class="flex gap-2">
                <el-input v-model="riskSearch" placeholder="搜索患者/医院" class="w-48"></el-input>
                <el-select v-model="riskLevel" placeholder="风险等级" class="w-24">
                  <el-option label="全部" value=""></el-option>
                  <el-option label="高" value="high"></el-option>
                  <el-option label="中" value="medium"></el-option>
                  <el-option label="低" value="low"></el-option>
                </el-select>
                <el-button type="primary">搜索</el-button>
              </div>
            </div>
            <el-table :data="riskEventList" border stripe :header-cell-style="{background: '#f5f7fa'}">
              <el-table-column prop="eventId" label="事件ID" width="120"></el-table-column>
              <el-table-column prop="patientName" label="患者姓名" width="100"></el-table-column>
              <el-table-column prop="hospital" label="医院名称"></el-table-column>
              <el-table-column prop="riskType" label="风险类型" width="120"></el-table-column>
              <el-table-column prop="riskLevel" label="风险等级" width="100">
                <template #default="scope">
                  <el-tag :type="scope.row.riskLevel === '高' ? 'danger' : scope.row.riskLevel === '中' ? 'warning' : 'info'">
                    {{ scope.row.riskLevel }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="eventTime" label="发生时间" width="180"></el-table-column>
              <el-table-column prop="handleStatus" label="处理状态" width="120">
                <template #default="scope">
                  <el-tag :type="scope.row.handleStatus === '已处理' ? 'success' : 'info'">
                    {{ scope.row.handleStatus }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="120">
                <template #default>
                  <el-button type="text" size="small" class="text-primary">详情</el-button>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- 其他页面占位 -->
        <div v-if="activeMenu === 'data-management' || activeMenu === 'system' || activeMenu === 'user' || activeMenu === 'log'" class="flex items-center justify-center h-64 bg-white rounded-lg">
          <div class="text-center">
            <i class="fa fa-file-text-o text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-400">该页面功能正在开发中...</p>
          </div>
        </div>
        
        <!-- 使用说明页面 -->
        <div v-if="activeMenu === 'help'" class="space-y-6">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
              <i class="fa fa-question-circle text-primary mr-3"></i>
              系统使用说明
            </h1>
            
            <!-- 管理员功能说明 -->
            <div class="space-y-6">
              <section>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">管理员功能</h2>
                
                <div class="space-y-4">
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-tachometer text-blue-600 mr-2"></i>
                      1. 数据概览
                    </h3>
                    <p class="text-gray-600 mb-2">查看系统的核心指标和统计数据：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>支付效率、康复衔接效率、赔付率、结算时间等核心指标</li>
                      <li>医保费用趋势图表（支持月度/季度/年度切换）</li>
                      <li>风控预警分布饼图</li>
                      <li>最近风控预警列表（支持刷新）</li>
                    </ul>
                  </div>
                  
                  <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-file-text-o text-green-600 mr-2"></i>
                      2. DRG支付政策管理
                    </h3>
                    <p class="text-gray-600 mb-2">管理DRG（按疾病诊断相关分组）支付政策：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>查看DRG政策列表，支持搜索和筛选</li>
                      <li>按DRG编码、名称、诊断进行搜索</li>
                      <li>按状态筛选（启用/禁用）</li>
                      <li>查看DRG分组统计柱状图</li>
                      <li>删除DRG政策（带确认提示）</li>
                    </ul>
                  </div>
                  
                  <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-hospital-o text-purple-600 mr-2"></i>
                      3. 康复服务衔接管理
                    </h3>
                    <p class="text-gray-600 mb-2">管理康复机构和转院申请：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>查看康复机构列表和详细信息</li>
                      <li>查看转院申请统计饼图</li>
                      <li>处理转院申请（批准/拒绝）</li>
                      <li>查看今日/本周/本月申请统计</li>
                      <li>按状态筛选转院申请</li>
                    </ul>
                  </div>
                  
                  <div class="bg-red-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-shield text-red-600 mr-2"></i>
                      4. 风控与预测管理
                    </h3>
                    <p class="text-gray-600 mb-2">管理风险事件和风控模型：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>查看风控模型概览（召回率、误报率、拦截成功率）</li>
                      <li>查看风险类型分布饼图</li>
                      <li>查看风险等级分布柱状图</li>
                      <li>管理风险事件列表（搜索、筛选）</li>
                      <li>按风险等级和类型筛选</li>
                    </ul>
                  </div>
                  
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-robot text-yellow-600 mr-2"></i>
                      5. AI助手（医保欺诈检测）
                    </h3>
                    <p class="text-gray-600 mb-2">使用AI助手进行医保欺诈检测和分析：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>点击右下角AI助手按钮打开对话框</li>
                      <li>询问关于医保欺诈检测的问题</li>
                      <li>分析医疗费用数据，识别潜在欺诈行为</li>
                      <li>获取风险评估报告和处理建议</li>
                      <li>支持上下文数据传递，提供更精准的分析</li>
                    </ul>
                  </div>
                </div>
              </section>
              
              <!-- 普通用户功能说明 -->
              <section class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">普通用户功能</h2>
                
                <div class="space-y-4">
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-hospital-o text-blue-600 mr-2"></i>
                      1. 医院列表浏览
                    </h3>
                    <p class="text-gray-600 mb-2">浏览和搜索医院信息：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>查看所有可用医院列表</li>
                      <li>按医院名称、专科进行搜索</li>
                      <li>按专科类型筛选（神经科、骨科、心内科、康复科等）</li>
                      <li>按医院等级筛选（三级、二级、一级）</li>
                      <li>按评分、价格、名称排序</li>
                      <li>查看医院评分、评价数量、平均费用等信息</li>
                    </ul>
                  </div>
                  
                  <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-info-circle text-green-600 mr-2"></i>
                      2. 医院详情查看
                    </h3>
                    <p class="text-gray-600 mb-2">查看医院的详细信息：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>点击医院卡片查看详细信息</li>
                      <li>查看医院地址、电话、专科、床位数等</li>
                      <li>查看医院简介和描述</li>
                      <li>查看其他用户的评价和评分</li>
                      <li>从详情页面直接申请转院</li>
                    </ul>
                  </div>
                  
                  <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-star text-purple-600 mr-2"></i>
                      3. 医院评价功能
                    </h3>
                    <p class="text-gray-600 mb-2">对医院进行评价：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>在医院详情页面添加评价</li>
                      <li>进行1-5星评分</li>
                      <li>填写评价内容</li>
                      <li>评价会影响医院的整体评分</li>
                    </ul>
                  </div>
                  
                  <div class="bg-red-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-file-text-o text-red-600 mr-2"></i>
                      4. 转院申请
                    </h3>
                    <p class="text-gray-600 mb-2">提交转院申请：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>在医院列表或详情页面点击"申请转院"</li>
                      <li>填写患者信息（姓名、身份证号、联系电话）</li>
                      <li>填写当前医院和目标医院</li>
                      <li>填写疾病名称和病情描述</li>
                      <li>填写转院原因和预期费用</li>
                      <li>提交后等待管理员审核</li>
                    </ul>
                  </div>
                  
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-list text-yellow-600 mr-2"></i>
                      5. 我的申请管理
                    </h3>
                    <p class="text-gray-600 mb-2">查看和管理转院申请：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>在"我的申请"标签页查看所有申请</li>
                      <li>查看申请状态（待审核、已批准、已拒绝）</li>
                      <li>查看申请详情（包括管理员备注）</li>
                      <li>按状态筛选申请</li>
                    </ul>
                  </div>
                  
                  <div class="bg-indigo-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-robot text-indigo-600 mr-2"></i>
                      6. AI助手（转院建议）
                    </h3>
                    <p class="text-gray-600 mb-2">使用AI助手获取转院建议：</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>点击右下角AI助手按钮打开对话框</li>
                      <li>询问转院相关问题，例如：</li>
                      <li class="ml-6">- "推荐治疗脑出血的医院"</li>
                      <li class="ml-6">- "价格实惠的康复医院"</li>
                      <li class="ml-6">- "评分高的神经科医院"</li>
                      <li>AI会根据医院列表和您的需求提供个性化建议</li>
                      <li>支持医院对比和转院流程咨询</li>
                    </ul>
                  </div>
                </div>
              </section>
              
              <!-- 通用功能说明 -->
              <section class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">通用功能</h2>
                
                <div class="space-y-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-user text-gray-600 mr-2"></i>
                      用户注册与登录
                    </h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>新用户可以通过注册页面创建账户</li>
                      <li>填写用户名、密码、真实姓名、身份证号、联系电话</li>
                      <li>登录后根据角色自动跳转到对应界面</li>
                      <li>管理员账户：admin / admin123</li>
                      <li>普通用户账户：user / user123</li>
                    </ul>
                  </div>
                  
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                      <i class="fa fa-shield text-gray-600 mr-2"></i>
                      权限管理
                    </h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-1 ml-4">
                      <li>系统根据用户角色显示不同界面</li>
                      <li>管理员可以访问所有管理功能</li>
                      <li>普通用户只能访问转院申请相关功能</li>
                      <li>未登录用户会自动跳转到登录页面</li>
                    </ul>
                  </div>
                </div>
              </section>
              
              <!-- 使用技巧 -->
              <section class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">使用技巧</h2>
                
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg">
                  <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>搜索功能：</strong>使用搜索框可以快速查找医院、DRG政策等信息</li>
                    <li><strong>筛选功能：</strong>使用下拉菜单可以按不同条件筛选数据</li>
                    <li><strong>排序功能：</strong>在用户界面可以按评分、价格等排序医院</li>
                    <li><strong>AI助手：</strong>充分利用AI助手获取智能建议和分析</li>
                    <li><strong>数据刷新：</strong>某些页面支持手动刷新获取最新数据</li>
                    <li><strong>详情查看：</strong>点击列表项可以查看详细信息</li>
                  </ul>
                </div>
              </section>
            </div>
          </div>
        </div>
      </main>
      
      <!-- AI助手对话框 -->
      <div class="relative">
        <!-- 展开/收起按钮 -->
        <button
          v-if="!aiAssistantVisible"
          @click="aiAssistantVisible = true"
          class="fixed right-4 bottom-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full shadow-2xl hover:shadow-xl hover:from-purple-700 hover:to-blue-700 transition-all duration-300 flex items-center justify-center z-50 px-6 py-3 space-x-2"
          title="打开AI助手"
        >
          <i class="fa fa-robot text-xl"></i>
          <span class="font-semibold text-sm">AI助手</span>
        </button>
        
        <!-- AI助手面板 -->
        <transition name="slide-left">
          <div
            v-if="aiAssistantVisible"
            class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl z-50 flex flex-col"
          >
            <!-- 头部 -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 flex items-center justify-between shadow-md">
              <div class="flex items-center">
                <i class="fa fa-robot text-xl mr-2"></i>
                <span class="font-semibold">AI助手</span>
              </div>
              <button
                @click="aiAssistantVisible = false"
                class="text-white hover:text-gray-200 transition-colors"
              >
                <i class="fa fa-times text-lg"></i>
              </button>
            </div>
            
            <!-- 消息列表 -->
            <div
              ref="aiMessageContainer"
              class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100"
            >
              <!-- 欢迎消息 -->
              <div v-if="!aiMessages || aiMessages.length === 0" class="text-center text-gray-400 py-8">
                <i class="fa fa-comments text-4xl mb-2"></i>
                <p>我是医保欺诈检测AI助手</p>
                <p class="text-sm mt-2">可以问我任何关于医保欺诈检测的问题</p>
              </div>
              
              <!-- 消息项 -->
              <div
                v-for="(msg, index) in (aiMessages || [])"
                :key="index"
                class="flex"
                :class="msg.role === 'user' ? 'justify-end' : 'justify-start'"
              >
                <div
                  class="max-w-[80%] rounded-lg p-3"
                  :class="msg.role === 'user' ? 'bg-blue-600 text-white shadow-md' : 'bg-blue-50 text-gray-800 shadow-md border border-blue-200'"
                >
                  <div class="text-sm whitespace-pre-wrap">{{ msg.content }}</div>
                  <div
                    class="text-xs mt-1 opacity-70"
                    :class="msg.role === 'user' ? 'text-white' : 'text-gray-500'"
                  >
                    {{ formatTime(msg.timestamp) }}
                  </div>
                </div>
              </div>
              
              <!-- 加载中 -->
              <div v-if="aiLoading" class="flex justify-start">
                <div class="bg-blue-50 rounded-lg p-3 shadow-md border border-blue-200">
                  <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="border-t border-gray-200 p-4 bg-white">
              <div class="flex space-x-2">
                <el-input
                  v-model="aiInputMessage"
                  placeholder="输入您的问题..."
                  @keyup.enter="sendAIMessage"
                  :disabled="aiLoading"
                  clearable
                >
                  <template #prefix>
                    <i class="fa fa-paper-plane text-gray-400"></i>
                  </template>
                </el-input>
                <el-button
                  type="primary"
                  @click="sendAIMessage"
                  :loading="aiLoading"
                  :disabled="!aiInputMessage.trim()"
                >
                  <i class="fa fa-send mr-1"></i>
                  发送
                </el-button>
              </div>
              <div class="mt-2 text-xs text-gray-400">
                <span>提示：可以询问关于风险分析、欺诈检测等问题</span>
              </div>
            </div>
          </div>
        </transition>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted, watch, nextTick } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;
    
    // API基础配置
    const API_BASE_URL = 'http://zephyr-w.online:3000/api';
    
    // 获取token
    const getToken = () => {
      return localStorage.getItem('token');
    };
    
    // 获取请求头
    const getHeaders = () => {
      const headers = { 'Content-Type': 'application/json' };
      const token = getToken();
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      return headers;
    };
    
    // API请求工具函数
    const api = {
      async get(url) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`, {
            headers: getHeaders()
          });
          const data = await response.json();
          
          // 如果token过期，跳转到登录页
          if (data.code === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            return null;
          }
          
          if (data.code === 200) {
            return data.data;
          } else {
            ElMessage.error(data.message || '请求失败');
            return null;
          }
        } catch (error) {
          ElMessage.error('网络请求失败');
          console.error(error);
          return null;
        }
      },
      async post(url, body) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify(body)
          });
          const data = await response.json();
          
          if (data.code === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            return null;
          }
          
          if (data.code === 200) {
            // 即使data.data为null，也返回true表示成功
            return data.data !== undefined ? data.data : true;
          } else {
            ElMessage.error(data.message || '操作失败');
            return null;
          }
        } catch (error) {
          ElMessage.error('网络请求失败');
          console.error(error);
          return null;
        }
      },
      async put(url, body) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`, {
            method: 'PUT',
            headers: getHeaders(),
            body: JSON.stringify(body)
          });
          const data = await response.json();
          
          if (data.code === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            return null;
          }
          
          if (data.code === 200) {
            // 即使data.data为null，也返回true表示成功
            return data.data !== undefined ? data.data : true;
          } else {
            ElMessage.error(data.message || '操作失败');
            return null;
          }
        } catch (error) {
          ElMessage.error('网络请求失败');
          console.error(error);
          return null;
        }
      },
      async delete(url) {
        try {
          const response = await fetch(`${API_BASE_URL}${url}`, {
            method: 'DELETE',
            headers: getHeaders()
          });
          const data = await response.json();
          
          if (data.code === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            return null;
          }
          
          if (data.code === 200) {
            return data.data;
          } else {
            ElMessage.error(data.message || '删除失败');
            return null;
          }
        } catch (error) {
          ElMessage.error('网络请求失败');
          console.error(error);
          return null;
        }
      }
    };
    
    const app = createApp({
      setup() {
        // 用户信息
        const userInfo = ref({
          username: '',
          realName: '',
          role: ''
        });
        
        // 检查登录状态
        const checkAuth = async () => {
          const token = getToken();
          if (!token) {
            window.location.href = 'login.html';
            return false;
          }
          
          // 从localStorage获取用户信息
          const savedUser = localStorage.getItem('user');
          if (savedUser) {
            try {
              userInfo.value = JSON.parse(savedUser);
            } catch (e) {
              console.error('解析用户信息失败:', e);
            }
          }
          
          // 验证token有效性
          try {
            const data = await api.get('/auth/me');
            if (data) {
              userInfo.value = data;
              localStorage.setItem('user', JSON.stringify(data));
            }
          } catch (error) {
            console.error('验证token失败:', error);
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            return false;
          }
          
          return true;
        };
        
        // 处理用户菜单命令
        const handleUserCommand = async (command) => {
          if (command === 'logout') {
            ElMessageBox.confirm('确定要退出登录吗？', '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'warning'
            }).then(async () => {
              // 调用登出接口
              await api.post('/auth/logout');
              // 清除本地存储
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              // 跳转到登录页
              window.location.href = 'login.html';
            }).catch(() => {});
          } else if (command === 'profile') {
            ElMessage.info('个人中心功能开发中...');
          }
        };
        
        // AI助手状态
        const aiAssistantVisible = ref(false);
        const aiMessages = ref([]);
        const aiInputMessage = ref('');
        const aiLoading = ref(false);
        const aiMessageContainer = ref(null);
        
        // 状态管理
        const activeMenu = ref('dashboard');
        const dateRange = ref([]);
        const feeType = ref('month');
        const loading = ref(false);
        
        // 数据概览
        const dashboardData = ref({
          paymentEfficiency: { value: 30, change: 5 },
          rehabilitationEfficiency: { value: 25, change: 0 },
          payoutRate: { value: 11, change: -8 },
          settlementTime: { value: 0.7, change: 0 }
        });
        
        // DRG页面状态
        const drgSearch = ref('');
        const drgStatus = ref('');
        const drgCurrentPage = ref(1);
        const drgPageSize = ref(10);
        const drgTotal = ref(0);
        const drgList = ref([]);
        
        // 康复服务页面状态
        const rehabSearch = ref('');
        const transferStatus = ref('');
        const rehabList = ref([]);
        const transferList = ref([]);
        const transferStats = ref({ today: 0, week: 0, month: 0 });
        
        // 康复机构表单相关状态
        const rehabDialogVisible = ref(false);
        const rehabDialogTitle = ref('新增康复机构');
        const rehabFormRef = ref(null);
        const rehabSubmitting = ref(false);
        const rehabForm = ref({
          id: null,
          name: '',
          level: '',
          bedCount: 0,
          specialty: '',
          priceLevel: '中等',
          address: '',
          phone: '',
          status: '营业中',
          description: ''
        });
        
        const rehabRules = {
          name: [
            { required: true, message: '请输入机构名称', trigger: 'blur' }
          ],
          level: [
            { required: true, message: '请选择机构等级', trigger: 'change' }
          ],
          bedCount: [
            { required: true, message: '请输入床位数', trigger: 'blur' },
            { type: 'number', min: 0, message: '床位数必须大于等于0', trigger: 'blur' }
          ]
        };
        
        // 康复机构详情相关状态
        const rehabDetailDialogVisible = ref(false);
        const rehabDetail = ref(null);
        
        // 风控页面状态
        const riskSearch = ref('');
        const riskLevel = ref('');
        const riskEventList = ref([]);
        const riskOverview = ref({ recall: 92, falsePositive: 12, success: 88 });
        
        // 预警列表数据
        const warningList = ref([]);
        
        // 图表实例
        const chartInstances = ref({});
        
        // 加载数据概览
        const loadDashboard = async () => {
          loading.value = true;
          try {
            const data = await api.get('/dashboard/overview');
            if (data) {
              dashboardData.value = data.metrics || dashboardData.value;
              warningList.value = data.warnings || [];
            }
            await nextTick();
            initDashboardCharts();
          } finally {
            loading.value = false;
          }
        };
        
        // 加载DRG列表
        const loadDrgList = async () => {
          loading.value = true;
          try {
            const params = new URLSearchParams({
              page: drgCurrentPage.value,
              pageSize: drgPageSize.value,
              search: drgSearch.value,
              status: drgStatus.value
            });
            const data = await api.get(`/drg?${params}`);
            if (data) {
              drgList.value = data.list || [];
              drgTotal.value = data.total || 0;
            }
            await nextTick();
            initDrgChart();
          } finally {
            loading.value = false;
          }
        };
        
        // 加载康复机构列表
        const loadRehabList = async () => {
          const data = await api.get('/rehabilitation/institutions');
          if (data) {
            rehabList.value = data.list || [];
          }
        };
        
        // 显示新增康复机构对话框
        const showRehabDialog = () => {
          rehabDialogTitle.value = '新增康复机构';
          rehabForm.value = {
            id: null,
            name: '',
            level: '',
            bedCount: 0,
            specialty: '',
            priceLevel: '中等',
            address: '',
            phone: '',
            status: '营业中',
            description: ''
          };
          rehabDialogVisible.value = true;
        };
        
        // 编辑康复机构
        const handleRehabEdit = async (row) => {
          try {
            const data = await api.get(`/rehabilitation/institutions/${row.id}`);
            if (data) {
              rehabDialogTitle.value = '修改康复机构';
              rehabForm.value = {
                id: data.id,
                name: data.name,
                level: data.level || '',
                bedCount: data.bedCount || 0,
                specialty: data.specialty || '',
                priceLevel: data.priceLevel || '中等',
                address: data.address || '',
                phone: data.phone || '',
                status: data.status || '营业中',
                description: data.description || ''
              };
              rehabDialogVisible.value = true;
            }
          } catch (error) {
            console.error('获取康复机构详情失败:', error);
            ElMessage.error('获取机构详情失败');
          }
        };
        
        // 重置康复机构表单
        const resetRehabForm = () => {
          if (rehabFormRef.value) {
            rehabFormRef.value.resetFields();
          }
          rehabForm.value = {
            id: null,
            name: '',
            level: '',
            bedCount: 0,
            specialty: '',
            priceLevel: '中等',
            address: '',
            phone: '',
            status: '营业中',
            description: ''
          };
        };
        
        // 提交康复机构表单
        const submitRehabForm = async () => {
          if (!rehabFormRef.value) return;
          
          await rehabFormRef.value.validate(async (valid) => {
            if (!valid) return;
            
            rehabSubmitting.value = true;
            try {
              const formData = {
                name: rehabForm.value.name.trim(),
                level: rehabForm.value.level,
                bedCount: Number(rehabForm.value.bedCount) || 0,
                specialty: rehabForm.value.specialty.trim(),
                priceLevel: rehabForm.value.priceLevel,
                address: rehabForm.value.address.trim(),
                phone: rehabForm.value.phone.trim(),
                status: rehabForm.value.status,
                description: rehabForm.value.description.trim()
              };
              
              let result;
              if (rehabForm.value.id) {
                // 编辑模式
                result = await api.put(`/rehabilitation/institutions/${rehabForm.value.id}`, formData);
              } else {
                // 新增模式
                result = await api.post('/rehabilitation/institutions', formData);
              }
              
              // 无论result是否为null，只要没有抛出异常就认为成功
              ElMessage.success(rehabForm.value.id ? '修改成功' : '新增成功');
              rehabDialogVisible.value = false;
              resetRehabForm();
              await loadRehabList();
            } catch (error) {
              console.error('提交失败:', error);
              ElMessage.error(error.message || '操作失败');
            } finally {
              rehabSubmitting.value = false;
            }
          });
        };
        
        // 显示康复机构详情
        const showRehabDetail = async (row) => {
          try {
            const data = await api.get(`/rehabilitation/institutions/${row.id}`);
            if (data) {
              rehabDetail.value = {
                id: data.id,
                name: data.name,
                level: data.level,
                bedCount: data.bedCount,
                specialty: data.specialty,
                status: data.status,
                rating: data.rating,
                priceLevel: data.priceLevel,
                address: data.address,
                phone: data.phone,
                description: data.description
              };
              rehabDetailDialogVisible.value = true;
            }
          } catch (error) {
            console.error('获取康复机构详情失败:', error);
            ElMessage.error('获取机构详情失败');
          }
        };
        
        // 加载转院申请
        const loadTransferList = async () => {
          loading.value = true;
          try {
            const params = new URLSearchParams({
              status: transferStatus.value
            });
            const data = await api.get(`/transfer/applications?${params}`);
            if (data) {
              // 格式化数据以匹配表格
              const list = Array.isArray(data.list) ? data.list : [];
              transferList.value = list.map(item => ({
                id: item.id,
                applyNo: item.apply_no,
                patientName: item.patient_name,
                fromHospital: item.from_hospital,
                toHospital: item.to_hospital || item.to_hospital_name,
                disease: item.disease,
                applyTime: item.apply_time,
                status: item.status,
                adminComment: item.admin_comment
              }));
            }
            // 加载统计数据（用于趋势图）
            await loadTransferStats();
            await nextTick();
            await initTransferChart();
          } finally {
            loading.value = false;
          }
        };
        
        // 加载风控数据
        const loadRiskData = async () => {
          loading.value = true;
          try {
            const params = new URLSearchParams({
              search: riskSearch.value,
              level: riskLevel.value
            });
            const data = await api.get(`/risk/events?${params}`);
            if (data) {
              riskEventList.value = data.list || [];
              riskOverview.value = data.overview || riskOverview.value;
            }
            await nextTick();
            initRiskCharts();
          } finally {
            loading.value = false;
          }
        };
        
        // 刷新预警列表
        const refreshWarnings = async () => {
          await loadDashboard();
          ElMessage.success('刷新成功');
        };
        
        // DRG操作
        const handleDrgSearch = () => {
          drgCurrentPage.value = 1;
          loadDrgList();
        };
        
        const handleDrgReset = () => {
          drgSearch.value = '';
          drgStatus.value = '';
          drgCurrentPage.value = 1;
          loadDrgList();
        };
        
        // DRG表单相关状态
        const drgDialogVisible = ref(false);
        const drgDialogTitle = ref('新增政策');
        const drgFormRef = ref(null);
        const drgSubmitting = ref(false);
        const drgForm = ref({
          id: null,
          drgCode: '',
          drgName: '',
          diagnosis: '',
          paymentStandard: 0,
          effectiveDate: '',
          status: '1'
        });
        
        const drgRules = {
          drgCode: [
            { required: true, message: '请输入DRG组编码', trigger: 'blur' },
            { pattern: /^[A-Z0-9]+$/, message: 'DRG编码只能包含大写字母和数字', trigger: 'blur' }
          ],
          drgName: [
            { required: true, message: '请输入DRG组名称', trigger: 'blur' }
          ],
          paymentStandard: [
            { required: true, message: '请输入支付标准', trigger: 'blur' },
            { type: 'number', min: 0, message: '支付标准必须大于等于0', trigger: 'blur' }
          ],
          effectiveDate: [
            { required: true, message: '请选择生效日期', trigger: 'change' }
          ]
        };
        
        // 显示新增对话框
        const showDrgDialog = () => {
          drgDialogTitle.value = '新增政策';
          drgForm.value = {
            id: null,
            drgCode: '',
            drgName: '',
            diagnosis: '',
            paymentStandard: 0,
            effectiveDate: new Date().toISOString().split('T')[0],
            status: '1'
          };
          drgDialogVisible.value = true;
        };
        
        // 重置表单
        const resetDrgForm = () => {
          if (drgFormRef.value) {
            drgFormRef.value.resetFields();
          }
          drgForm.value = {
            id: null,
            drgCode: '',
            drgName: '',
            diagnosis: '',
            paymentStandard: 0,
            effectiveDate: '',
            status: '1'
          };
        };
        
        // 编辑DRG政策
        const handleDrgEdit = async (row) => {
          try {
            // 获取完整数据（包含原始数值）
            const data = await api.get(`/drg/${row.id}`);
            if (data) {
              drgDialogTitle.value = '编辑政策';
              drgForm.value = {
                id: data.id,
                drgCode: data.drgCode,
                drgName: data.drgName,
                diagnosis: data.diagnosis || '',
                paymentStandard: data.paymentStandard || 0,
                effectiveDate: data.effectiveDate || '',
                status: data.status || '1'
              };
              drgDialogVisible.value = true;
            }
          } catch (error) {
            console.error('获取DRG政策详情失败:', error);
            ElMessage.error('获取政策详情失败');
          }
        };
        
        // 提交表单
        const submitDrgForm = async () => {
          if (!drgFormRef.value) return;
          
          await drgFormRef.value.validate(async (valid) => {
            if (!valid) return;
            
            drgSubmitting.value = true;
            try {
              const formData = {
                drgCode: drgForm.value.drgCode.trim(),
                drgName: drgForm.value.drgName.trim(),
                diagnosis: drgForm.value.diagnosis.trim(),
                paymentStandard: drgForm.value.paymentStandard || 0,
                effectiveDate: drgForm.value.effectiveDate,
                status: drgForm.value.status
              };
              
              let result;
              if (drgForm.value.id) {
                // 编辑
                result = await api.put(`/drg/${drgForm.value.id}`, formData);
              } else {
                // 新增
                result = await api.post('/drg', formData);
              }
              
              // 无论result是否为null，只要没有抛出异常就认为成功
              // 因为PUT请求可能返回null但状态码是200
              ElMessage.success(drgForm.value.id ? '编辑成功' : '新增成功');
              drgDialogVisible.value = false;
              resetDrgForm();
              // 刷新列表以显示最新数据
              await loadDrgList();
            } catch (error) {
              console.error('提交失败:', error);
              ElMessage.error(error.message || '操作失败');
            } finally {
              drgSubmitting.value = false;
            }
          });
        };
        
        const handleDrgDelete = async (row) => {
          try {
            await ElMessageBox.confirm('确定要删除这条DRG政策吗？', '提示', {
              type: 'warning'
            });
            const result = await api.delete(`/drg/${row.id}`);
            if (result !== null) {
              ElMessage.success('删除成功');
              loadDrgList();
            }
          } catch (e) {
            // 用户取消
          }
        };
        
        // 转院申请操作
        const handleTransferApprove = async (row) => {
          try {
            // 检查申请状态
            if (row.status !== 'pending') {
              ElMessage.warning('该申请已处理，无法操作');
              return;
            }
            
            const { value } = await ElMessageBox.prompt('请输入审批备注（可选）', '批准申请', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              inputType: 'textarea',
              inputPlaceholder: '请输入审批备注（可选）',
              inputValidator: () => true
            }).catch(() => ({ value: '' }));
            
            const result = await api.put(`/transfer/applications/${row.id}/approve`, { 
              adminComment: value || ''
            });
            if (result !== null) {
              ElMessage.success('申请已批准');
              loadTransferList();
              // 刷新统计信息
              loadTransferStats();
            }
          } catch (e) {
            if (e !== 'cancel') {
              console.error('批准申请失败:', e);
              ElMessage.error(e.message || '批准申请失败');
            }
          }
        };
        
        const handleTransferReject = async (row) => {
          try {
            // 检查申请状态
            if (row.status !== 'pending') {
              ElMessage.warning('该申请已处理，无法操作');
              return;
            }
            
            const { value } = await ElMessageBox.prompt('请输入拒绝原因', '拒绝申请', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              inputType: 'textarea',
              inputPlaceholder: '请输入拒绝原因（必填）',
              inputValidator: (val) => {
                if (!val || val.trim() === '') {
                  return '拒绝原因不能为空';
                }
                return true;
              }
            }).catch(() => ({ value: null }));
            
            if (value) {
              const result = await api.put(`/transfer/applications/${row.id}/reject`, { 
                adminComment: value 
              });
              if (result !== null) {
                ElMessage.success('申请已拒绝');
                loadTransferList();
                // 刷新统计信息
                loadTransferStats();
              }
            }
          } catch (e) {
            if (e !== 'cancel') {
              console.error('拒绝申请失败:', e);
              ElMessage.error(e.message || '拒绝申请失败');
            }
          }
        };
        
        // 查看转院申请详情
        const viewTransferDetail = async (row) => {
          try {
            const data = await api.get(`/transfer/applications/${row.id}`);
            if (data) {
              ElMessageBox.alert(
                `<div class="text-left space-y-2">
                  <p><strong>申请单号：</strong>${data.apply_no || row.applyNo}</p>
                  <p><strong>患者姓名：</strong>${data.patient_name || row.patientName}</p>
                  <p><strong>身份证号：</strong>${data.patient_id_card || '未填写'}</p>
                  <p><strong>联系电话：</strong>${data.patient_phone || '未填写'}</p>
                  <p><strong>转出医院：</strong>${data.from_hospital || row.fromHospital || '未填写'}</p>
                  <p><strong>转入医院：</strong>${data.to_hospital_name || data.to_hospital || row.toHospital || '未填写'}</p>
                  <p><strong>疾病名称：</strong>${data.disease || '未填写'}</p>
                  <p><strong>病情描述：</strong>${data.disease_description || '未填写'}</p>
                  <p><strong>转院原因：</strong>${data.reason || '未填写'}</p>
                  <p><strong>预期费用：</strong>¥${data.expected_cost || 0}</p>
                  <p><strong>申请时间：</strong>${formatDateTime(data.apply_time || row.applyTime)}</p>
                  <p><strong>状态：</strong>${data.status === 'pending' ? '待审核' : data.status === 'approved' ? '已批准' : '已拒绝'}</p>
                  ${data.admin_comment ? `<p><strong>管理员备注：</strong>${data.admin_comment}</p>` : ''}
                </div>`,
                '转院申请详情',
                {
                  dangerouslyUseHTMLString: true,
                  confirmButtonText: '关闭'
                }
              );
            }
          } catch (error) {
            console.error('查看申请详情失败:', error);
            ElMessage.error('获取申请详情失败');
          }
        };
        
        // 格式化日期时间
        const formatDateTime = (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        };
        
        // 加载转院申请统计
        const loadTransferStats = async () => {
          try {
            const data = await api.get('/transfer/applications/stats');
            if (data) {
              transferStats.value = {
                today: data.today || 0,
                week: data.week || 0,
                month: data.month || 0,
                pending: data.pending || 0,
                approved: data.approved || 0,
                rejected: data.rejected || 0,
                total: data.total || 0
              };
            }
          } catch (error) {
            console.error('加载统计信息失败:', error);
          }
        };
        
        // 方法
        const handleSizeChange = (val) => {
          drgPageSize.value = val;
          loadDrgList();
        };
        
        const handleCurrentChange = (val) => {
          drgCurrentPage.value = val;
          loadDrgList();
        };
        
        // AI助手相关方法
        const formatTime = (timestamp) => {
          if (!timestamp) return '';
          const date = new Date(timestamp);
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          return `${hours}:${minutes}`;
        };
        
        const scrollToBottom = () => {
          nextTick(() => {
            if (aiMessageContainer.value) {
              aiMessageContainer.value.scrollTop = aiMessageContainer.value.scrollHeight;
            }
          });
        };
        
        const sendAIMessage = async () => {
          const message = aiInputMessage.value.trim();
          if (!message || aiLoading.value) return;
          
          // 添加用户消息
          const userMessage = {
            role: 'user',
            content: message,
            timestamp: new Date().toISOString()
          };
          aiMessages.value.push(userMessage);
          aiInputMessage.value = '';
          scrollToBottom();
          
          // 发送到AI助手
          aiLoading.value = true;
          try {
            const data = await api.post('/ai-assistant/chat', {
              message: message,
              context: {
                // 可以添加当前页面的上下文数据
                currentPage: activeMenu.value
              }
            });
            
            if (data && data.response) {
              // 添加AI回复
              aiMessages.value.push({
                role: 'assistant',
                content: data.response,
                timestamp: data.timestamp || new Date().toISOString()
              });
              scrollToBottom();
            } else {
              ElMessage.error('AI助手暂时无法响应，请稍后重试');
            }
          } catch (error) {
            console.error('发送AI消息失败:', error);
            ElMessage.error('发送消息失败，请检查网络连接');
          } finally {
            aiLoading.value = false;
          }
        };
        
        // 监听消息变化，自动滚动到底部
        watch(aiMessages, () => {
          scrollToBottom();
        }, { deep: true });
        
        // 监听加载状态，自动滚动
        watch(aiLoading, (newVal) => {
          if (!newVal) {
            scrollToBottom();
          }
        });
        
        // 初始化数据概览图表
        const initDashboardCharts = async () => {
          await nextTick(); // 确保 DOM 渲染完成
          
          const feeData = await api.get('/dashboard/fee-trend?type=' + feeType.value);
          
          // 医保费用趋势图
          const feeTrendEl = document.getElementById('feeTrendChart');
          if (feeTrendEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.feeTrend) {
              try {
                chartInstances.value.feeTrend.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.feeTrend = echarts.init(feeTrendEl);
          }
          if (chartInstances.value.feeTrend) {
            const chartData = feeData || {
              months: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月'],
              total: [1200, 1350, 1500, 1420, 1600, 1750, 1820, 1900, 2050],
              medical: [850, 950, 1050, 980, 1120, 1230, 1280, 1350, 1450],
              personal: [350, 400, 450, 440, 480, 520, 540, 550, 600]
            };
            chartInstances.value.feeTrend.setOption({
              tooltip: { trigger: 'axis' },
              legend: { data: ['医保支付', '个人支付', '总费用'], top: 0 },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'category', data: chartData.months },
              yAxis: { type: 'value', name: '万元' },
              series: [
                {
                  name: '总费用',
                  type: 'line',
                  data: chartData.total,
                  smooth: true,
                  lineStyle: { color: '#165DFF' },
                  itemStyle: { color: '#165DFF' }
                },
                {
                  name: '医保支付',
                  type: 'line',
                  data: chartData.medical,
                  smooth: true,
                  lineStyle: { color: '#36CFC9' },
                  itemStyle: { color: '#36CFC9' }
                },
                {
                  name: '个人支付',
                  type: 'line',
                  data: chartData.personal,
                  smooth: true,
                  lineStyle: { color: '#FAAD14' },
                  itemStyle: { color: '#FAAD14' }
                }
              ]
            });
          }
          
          // 风控预警分布图
          const riskDistEl = document.getElementById('riskDistributionChart');
          if (riskDistEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.riskDistribution) {
              try {
                chartInstances.value.riskDistribution.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.riskDistribution = echarts.init(riskDistEl);
          }
          if (chartInstances.value.riskDistribution) {
            const riskData = await api.get('/dashboard/risk-distribution');
            const chartData = riskData || [
              { value: 35, name: '虚假住院' },
              { value: 45, name: '异常费用' },
              { value: 15, name: '过度医疗' },
              { value: 5, name: '其他欺诈' }
            ];
            chartInstances.value.riskDistribution.setOption({
              tooltip: { trigger: 'item' },
              legend: { top: '5%', left: 'center' },
              series: [{
                name: '预警类型',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                  borderRadius: 10,
                  borderColor: '#fff',
                  borderWidth: 2
                },
                label: { show: false, position: 'center' },
                emphasis: {
                  label: { show: true, fontSize: 16, fontWeight: 'bold' }
                },
                labelLine: { show: false },
                data: chartData
              }]
            });
          }
        };
        
        // 初始化DRG图表
        const initDrgChart = async () => {
          await nextTick(); // 确保 DOM 渲染完成
          
          const drgEl = document.getElementById('drgGroupChart');
          if (drgEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.drgGroup) {
              try {
                chartInstances.value.drgGroup.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.drgGroup = echarts.init(drgEl);
          }
          if (chartInstances.value.drgGroup) {
            const data = await api.get('/drg/statistics');
            const chartData = data || {
              codes: ['MDC01', 'MDC02', 'MDC03', 'MDC04', 'MDC05', 'MDC06', 'MDC07', 'MDC08'],
              counts: [1200, 1500, 1800, 2100, 1600, 1300, 900, 700]
            };
            chartInstances.value.drgGroup.setOption({
              tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'category', data: chartData.codes },
              yAxis: { type: 'value', name: '例' },
              series: [{
                name: '病例数',
                type: 'bar',
                data: chartData.counts,
                itemStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#165DFF' },
                    { offset: 1, color: '#36CFC9' }
                  ])
                }
              }]
            });
          }
        };
        
        // 初始化转院申请图表
        const initTransferChart = async () => {
          await nextTick(); // 确保 DOM 渲染完成
          
          const transferEl = document.getElementById('transferApplyChart');
          if (transferEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.transferApply) {
              try {
                chartInstances.value.transferApply.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.transferApply = echarts.init(transferEl);
          }
          if (chartInstances.value.transferApply) {
            const data = await api.get('/rehabilitation/transfer-stats');
            const chartData = data || [
              { value: 65, name: '待审核' },
              { value: 25, name: '已通过' },
              { value: 10, name: '已拒绝' }
            ];
            chartInstances.value.transferApply.setOption({
              tooltip: { trigger: 'item' },
              series: [{
                name: '申请状态',
                type: 'doughnut',
                radius: ['50%', '70%'],
                data: chartData,
                itemStyle: {
                  borderRadius: 8
                },
                color: ['#165DFF', '#52C41A', '#FF4D4F']
              }]
            });
          }
          
          // 申请趋势柱状图
          const trendEl = document.getElementById('transferTrendChart');
          if (trendEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.transferTrend) {
              try {
                chartInstances.value.transferTrend.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.transferTrend = echarts.init(trendEl);
          }
          if (chartInstances.value.transferTrend) {
            // 使用统计数据绘制趋势图
            const trendData = {
              categories: ['今日', '本周', '本月'],
              values: [
                transferStats.value?.today || 0,
                transferStats.value?.week || 0,
                transferStats.value?.month || 0
              ]
            };
            
            chartInstances.value.transferTrend.setOption({
              tooltip: {
                trigger: 'axis',
                axisPointer: {
                  type: 'shadow'
                },
                formatter: '{b}: {c} 件'
              },
              grid: {
                left: '10%',
                right: '10%',
                bottom: '15%',
                top: '10%',
                containLabel: true
              },
              xAxis: {
                type: 'category',
                data: trendData.categories,
                axisLabel: {
                  fontSize: 12
                }
              },
              yAxis: {
                type: 'value',
                name: '申请数',
                nameTextStyle: {
                  fontSize: 12
                },
                axisLabel: {
                  fontSize: 12
                }
              },
              series: [{
                name: '申请数量',
                type: 'bar',
                data: trendData.values,
                itemStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#165DFF' },
                    { offset: 1, color: '#36CFC9' }
                  ]),
                  borderRadius: [4, 4, 0, 0]
                },
                label: {
                  show: true,
                  position: 'top',
                  fontSize: 12,
                  fontWeight: 'bold'
                }
              }]
            });
          }
        };
        
        // 初始化风控图表
        const initRiskCharts = async () => {
          await nextTick(); // 确保 DOM 渲染完成
          
          // 风险类型分布图
          const riskTypeEl = document.getElementById('riskTypeChart');
          if (riskTypeEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.riskType) {
              try {
                chartInstances.value.riskType.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.riskType = echarts.init(riskTypeEl);
          }
          if (chartInstances.value.riskType) {
            const typeData = await api.get('/risk/type-distribution');
            const chartData = typeData || [
              { value: 40, name: '虚假住院' },
              { value: 30, name: '过度医疗' },
              { value: 20, name: '重复收费' },
              { value: 10, name: '其他' }
            ];
            chartInstances.value.riskType.setOption({
              tooltip: { trigger: 'item' },
              legend: { top: 'bottom' },
              series: [{
                name: '风险类型',
                type: 'pie',
                radius: ['40%', '60%'],
                data: chartData,
                itemStyle: {
                  color: function(params) {
                    const colors = ['#FF4D4F', '#FAAD14', '#165DFF', '#36CFC9'];
                    return colors[params.dataIndex % colors.length];
                  }
                }
              }]
            });
          }
          
          // 风险等级分布图
          const riskLevelEl = document.getElementById('riskLevelChart');
          if (riskLevelEl) {
            // 如果图表实例已存在，先销毁
            if (chartInstances.value.riskLevel) {
              try {
                chartInstances.value.riskLevel.dispose();
              } catch (e) {
                // 忽略销毁错误
              }
            }
            // 重新初始化图表
            chartInstances.value.riskLevel = echarts.init(riskLevelEl);
          }
          if (chartInstances.value.riskLevel) {
            const levelData = await api.get('/risk/level-distribution');
            const chartData = levelData || {
              levels: ['高风险', '中风险', '低风险'],
              counts: [120, 350, 580]
            };
            chartInstances.value.riskLevel.setOption({
              tooltip: { trigger: 'axis' },
              grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
              xAxis: { type: 'category', data: chartData.levels },
              yAxis: { type: 'value', name: '件' },
              series: [{
                name: '风险事件数',
                type: 'bar',
                barWidth: '60%',
                data: chartData.counts,
                itemStyle: {
                  color: function(params) {
                    const colors = ['#FF4D4F', '#FAAD14', '#52C41A'];
                    return colors[params.dataIndex];
                  }
                }
              }]
            });
          }
        };
        
        // 窗口大小变化时重绘图表
        const resizeCharts = () => {
          Object.values(chartInstances.value).forEach(chart => {
            if (chart) chart.resize();
          });
        };
        
        // 监听菜单切换
        watch(activeMenu, (newVal) => {
          nextTick(async () => {
            // 等待 DOM 完全渲染
            await nextTick();
            if (newVal === 'dashboard') {
              await loadDashboard();
            } else if (newVal === 'drg') {
              await loadDrgList();
            } else if (newVal === 'rehabilitation') {
              await loadRehabList();
              loadTransferList();
              loadTransferStats();
            } else if (newVal === 'risk-control') {
              await loadRiskData();
            }
          });
        });
        
        // 监听转院申请状态筛选
        watch(transferStatus, () => {
          if (activeMenu.value === 'rehabilitation') {
            loadTransferList();
          }
        });
        
        // 监听费用类型变化
        watch(feeType, () => {
          if (activeMenu.value === 'dashboard') {
            initDashboardCharts();
          }
        });
        
        // 初始化
        onMounted(async () => {
          // 检查登录状态
          const isAuthenticated = await checkAuth();
          if (!isAuthenticated) {
            return;
          }
          
          loadDashboard();
          window.addEventListener('resize', resizeCharts);
        });
        
        return {
          userInfo,
          handleUserCommand,
          activeMenu,
          dateRange,
          feeType,
          loading,
          dashboardData,
          drgSearch,
          drgStatus,
          drgCurrentPage,
          drgPageSize,
          drgTotal,
          drgList,
          rehabSearch,
          transferStatus,
          rehabList,
          transferList,
          transferStats,
          // 康复机构表单相关
          rehabDialogVisible,
          rehabDialogTitle,
          rehabFormRef,
          rehabSubmitting,
          rehabForm,
          rehabRules,
          showRehabDialog,
          handleRehabEdit,
          resetRehabForm,
          submitRehabForm,
          // 康复机构详情相关
          rehabDetailDialogVisible,
          rehabDetail,
          showRehabDetail,
          riskSearch,
          riskLevel,
          riskEventList,
          riskOverview,
          warningList,
          loadDashboard,
          refreshWarnings,
          handleDrgSearch,
          handleDrgReset,
          showDrgDialog,
          handleDrgEdit,
          handleDrgDelete,
          submitDrgForm,
          resetDrgForm,
          drgDialogVisible,
          drgDialogTitle,
          drgForm,
          drgFormRef,
          drgSubmitting,
          loadRehabList,
          loadTransferList,
          loadTransferStats,
          handleTransferApprove,
          handleTransferReject,
          viewTransferDetail,
          formatDateTime,
          handleSizeChange,
          handleCurrentChange,
          // AI助手相关
          aiAssistantVisible,
          aiMessages,
          aiInputMessage,
          aiLoading,
          aiMessageContainer,
          sendAIMessage,
          formatTime
        };
      }
    });
    
    // 全局注册Element Plus组件
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>
</html>